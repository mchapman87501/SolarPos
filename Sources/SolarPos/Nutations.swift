import Foundation

// swiftlint:disable identifier_name type_name

internal struct TableA_4_3 {
    struct Rec {
        let y0: Double
        let y1: Double
        let y2: Double
        let y3: Double
        let y4: Double
        let a: Double
        let b: Double
        let c: Double
        let d: Double
    }

    static let coeffs = [
        Rec(y0: 0, y1: 0, y2: 0, y3: 0, y4: 1, a: -171996, b: -174.2, c: 92025, d: 8.9),
        Rec(y0: -2, y1: 0, y2: 0, y3: 2, y4: 2, a: -13187, b: -1.6, c: 5736, d: -3.1),
        Rec(y0: 0, y1: 0, y2: 0, y3: 2, y4: 2, a: -2274, b: -0.2, c: 977, d: -0.5),
        Rec(y0: 0, y1: 0, y2: 0, y3: 0, y4: 2, a: 2062, b: 0.2, c: -895, d: 0.5),
        Rec(y0: 0, y1: 1, y2: 0, y3: 0, y4: 0, a: 1426, b: -3.4, c: 54, d: -0.1),
        Rec(y0: 0, y1: 0, y2: 1, y3: 0, y4: 0, a: 712, b: 0.1, c: -7, d: 0.0),
        Rec(y0: -2, y1: 1, y2: 0, y3: 2, y4: 2, a: -517, b: 1.2, c: 224, d: -0.6),
        Rec(y0: 0, y1: 0, y2: 0, y3: 2, y4: 1, a: -386, b: -0.4, c: 200, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 1, y3: 2, y4: 2, a: -301, b: 0.0, c: 129, d: -0.1),
        Rec(y0: -2, y1: -1, y2: 0, y3: 2, y4: 2, a: 217, b: -0.5, c: -95, d: 0.3),
        Rec(y0: -2, y1: 0, y2: 1, y3: 0, y4: 0, a: -158, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 0, y3: 2, y4: 1, a: 129, b: 0.1, c: -70, d: 0.0),
        Rec(y0: 0, y1: 0, y2: -1, y3: 2, y4: 2, a: 123, b: 0.0, c: -53, d: 0.0),
        Rec(y0: 2, y1: 0, y2: 0, y3: 0, y4: 0, a: 63, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 1, y3: 0, y4: 1, a: 63, b: 0.1, c: -33, d: 0.0),
        Rec(y0: 2, y1: 0, y2: -1, y3: 2, y4: 2, a: -59, b: 0.0, c: 26, d: 0.0),
        Rec(y0: 0, y1: 0, y2: -1, y3: 0, y4: 1, a: -58, b: -0.1, c: 32, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 1, y3: 2, y4: 1, a: -51, b: 0.0, c: 27, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 2, y3: 0, y4: 0, a: 48, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 0, y2: -2, y3: 2, y4: 1, a: 46, b: 0.0, c: -24, d: 0.0),
        Rec(y0: 2, y1: 0, y2: 0, y3: 2, y4: 2, a: -38, b: 0.0, c: 16, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 2, y3: 2, y4: 2, a: -31, b: 0.0, c: 13, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 2, y3: 0, y4: 0, a: 29, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 1, y3: 2, y4: 2, a: 29, b: 0.0, c: -12, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 0, y3: 2, y4: 0, a: 26, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 0, y3: 2, y4: 0, a: -22, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 0, y2: -1, y3: 2, y4: 1, a: 21, b: 0.0, c: -10, d: 0.0),
        Rec(y0: 0, y1: 2, y2: 0, y3: 0, y4: 0, a: 17, b: -0.1, c: 0.0, d: 0.0),
        Rec(y0: 2, y1: 0, y2: -1, y3: 0, y4: 1, a: 16, b: 0.0, c: -8, d: 0.0),
        Rec(y0: -2, y1: 2, y2: 0, y3: 2, y4: 2, a: -16, b: 0.1, c: 7, d: 0.0),
        Rec(y0: 0, y1: 1, y2: 0, y3: 0, y4: 1, a: -15, b: 0.0, c: 9, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 1, y3: 0, y4: 1, a: -13, b: 0.0, c: 7, d: 0.0),
        Rec(y0: 0, y1: -1, y2: 0, y3: 0, y4: 1, a: -12, b: 0.0, c: 6, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 2, y3: -2, y4: 0, a: 11, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 2, y1: 0, y2: -1, y3: 2, y4: 1, a: -10, b: 0.0, c: 5, d: 0.0),
        Rec(y0: 2, y1: 0, y2: 1, y3: 2, y4: 2, a: -8, b: 0.0, c: 3, d: 0.0),
        Rec(y0: 0, y1: 1, y2: 0, y3: 2, y4: 2, a: 7, b: 0.0, c: -3, d: 0.0),
        Rec(y0: -2, y1: 1, y2: 1, y3: 0, y4: 0, a: -7, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: -1, y2: 0, y3: 2, y4: 2, a: -7, b: 0.0, c: 3, d: 0.0),
        Rec(y0: 2, y1: 0, y2: 0, y3: 2, y4: 1, a: -7, b: 0.0, c: 3, d: 0.0),
        Rec(y0: 2, y1: 0, y2: 1, y3: 0, y4: 0, a: 6, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 2, y3: 2, y4: 2, a: 6, b: 0.0, c: -3, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 1, y3: 2, y4: 1, a: 6, b: 0.0, c: -3, d: 0.0),
        Rec(y0: 2, y1: 0, y2: -2, y3: 0, y4: 1, a: -6, b: 0.0, c: 3, d: 0.0),
        Rec(y0: 2, y1: 0, y2: 0, y3: 0, y4: 1, a: -6, b: 0.0, c: 3, d: 0.0),
        Rec(y0: 0, y1: -1, y2: 1, y3: 0, y4: 0, a: 5, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -2, y1: -1, y2: 0, y3: 2, y4: 1, a: -5, b: 0.0, c: 3, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 0, y3: 0, y4: 1, a: -5, b: 0.0, c: 3, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 2, y3: 2, y4: 1, a: -5, b: 0.0, c: 3, d: 0.0),
        Rec(y0: -2, y1: 0, y2: 2, y3: 0, y4: 1, a: 4, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -2, y1: 1, y2: 0, y3: 2, y4: 1, a: 4, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 1, y3: -2, y4: 0, a: 4, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -1, y1: 0, y2: 1, y3: 0, y4: 0, a: -4, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -2, y1: 1, y2: 0, y3: 0, y4: 0, a: -4, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 1, y1: 0, y2: 0, y3: 0, y4: 0, a: -4, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 1, y3: 2, y4: 0, a: 3, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 0, y2: -2, y3: 2, y4: 2, a: -3, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: -1, y1: -1, y2: 1, y3: 0, y4: 0, a: -3, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 1, y2: 1, y3: 0, y4: 0, a: -3, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: -1, y2: 1, y3: 2, y4: 2, a: -3, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 2, y1: -1, y2: -1, y3: 2, y4: 2, a: -3, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 0, y1: 0, y2: 3, y3: 2, y4: 2, a: -3, b: 0.0, c: 0.0, d: 0.0),
        Rec(y0: 2, y1: -1, y2: 0, y3: 2, y4: 2, a: -3, b: 0.0, c: 0.0, d: 0.0)
    ]
}

public struct Nutations {

    // These terms describe the nutation of Earth's rotational axis with
    // respect to the plane of the ecliptic.  For background see
    // Chapter 22 of "Astronomical Algorithms", 2nd Ed., by Jean Meeus,
    // Willmann-Bell, Inc. 1998
    public let longitude: Double // Nutation in longitude
    public let obliquity: Double // Nutation in obliquity

    // I've no idea what these functions are describing.
    // It's interesting that they are all order3 polynomial
    // functions of jce, the Julian Ephemeris Century
    // They're all basically straight lines with huge slopes.

    // Mean elongation of the moon from the sun, degrees:
    // In astronomy, the elongation of a body is the angle between
    // that body and the sun, as seen by an observer on the earth.
    // https://en.wikipedia.org/wiki/Elongation_(astronomy)
    fileprivate static func getX0(jce: Double) -> Double {
        let jce2 = jce * jce
        let jce3 = jce2 * jce
        let result = 297.85036 + 445267.111480 * jce -
                     0.0019142 * jce2 + (jce3 / 189474.0)
        return result
    }

    // Mean anomaly of the sun(Earth), degrees:
    // https://en.wikipedia.org/wiki/Mean_anomaly
    // I don't have a good understanding of this, but if a body moved
    // like the hand of a clock - in a perfect circle, at a constant
    // angular rate, the mean anomaly describes where it would be in
    // its orbit (what "o'clock" it has) at a given time.  This is in
    // contrast to the real, Keplerian orbit of the body.
    fileprivate static func getX1(jce: Double) -> Double {
        let jce2 = jce * jce
        let jce3 = jce2 * jce

        let result = 357.52772 + 35999.050340 * jce -
                     0.0001603 * jce2 + (jce3 / 300000.0)
        return result
    }

    // Mean anomaly of the moon, degrees - see above for description.
    fileprivate static func getX2(jce: Double) -> Double {
        let jce2 = jce * jce
        let jce3 = jce2 * jce

        let result = 134.96298 + 477198.867398 * jce +
                     0.0086972 * jce2 + (jce3 / 56250.0)
        return result
    }

    // Moon's argument of latitude:
    // https://en.wikipedia.org/wiki/Argument_of_latitude
    // I don't know what an 'ascending node' is.  So, just go read
    // Wikipedia.
    fileprivate static func getX3(jce: Double) -> Double {
        let jce2 = jce * jce
        let jce3 = jce2 * jce

        let result = 93.27191 + 483202.017538 * jce - 0.0036825 * jce2 + (jce3 / 327270.0)
        return result
    }

    // Longitude of the ascending node of the moon's mean orbit on the
    // ecliptic, measured from the mean equinox of the date, degrees.
    fileprivate static func getX4(jce: Double) -> Double {
        let jce2 = jce * jce
        let jce3 = jce2 * jce

        let result = 125.04452 - 1934.136261 * jce + 0.0020708 * jce2 + (jce3 / 450000)
        return result
    }

    fileprivate static func getXValues(jce: Double) -> [Double] {
        return [getX0, getX1, getX2, getX3, getX4].map { $0(jce) }
    }

    fileprivate struct PsiEpsilon {
        let psi: Double     // nutation in longitude term, degrees
        let epsilon: Double // nutation in obliquity term, degrees

        init(rec: TableA_4_3.Rec, jce: Double, x: [Double]) {
            let y = [rec.y0, rec.y1, rec.y2, rec.y3, rec.y4]
            let xyTerms = (0..<x.count).map { x[$0] * y[$0] }
            let xySumDegrees = xyTerms.reduce(0.0) { $0 + $1 }

            let xySum = rads(xySumDegrees)
            psi = (rec.a + rec.b * jce) * sin(xySum)
            epsilon = (rec.c + rec.d * jce) * cos(xySum)
        }
    }

    public init(jce: Double) {
        let x = Nutations.getXValues(jce: jce)
        let peValues = TableA_4_3.coeffs.map { PsiEpsilon(rec: $0, jce: jce, x: x) }
        let psiSum = peValues.reduce(0.0) { $0 + $1.psi }
        let epsSum = peValues.reduce(0.0) { $0 + $1.epsilon }

        let denom = 36000000.0
        longitude = psiSum / denom
        obliquity = epsSum / denom
    }
}
